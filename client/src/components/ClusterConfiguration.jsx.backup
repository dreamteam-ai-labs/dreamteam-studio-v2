import React, { useState, useEffect, useCallback } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { RefreshCw, Trash2, Plus, ChevronUp, ChevronDown, ChevronRight, Info, HelpCircle } from 'lucide-react';
import { 
  createClusteringScenario, 
  getClusteringScenarios, 
  getClusteringScenarioDetails,
  deleteClusteringScenario 
} from '../services/api';
import { formatDateTime } from '../utils/dateUtils';
import ScenarioResults from './ScenarioResults';
import ColumnSelector from './ColumnSelector';
import ClusterVisualization from './ClusterVisualization';

function ClusterConfiguration({ entityType = 'problem' }) {
  const queryClient = useQueryClient();
  
  // State for controls
  const [kValue, setKValue] = useState(20);
  const [similarityThreshold, setSimilarityThreshold] = useState(entityType === 'problem' ? 0.55 : 0.60);
  const [selectedScenarioId, setSelectedScenarioId] = useState(null);
  const [showResults, setShowResults] = useState(false);
  const [showCreatePanel, setShowCreatePanel] = useState(false);
  const [sortField, setSortField] = useState('requested_at');
  const [sortOrder, setSortOrder] = useState('desc');
  const [expandedScenarioId, setExpandedScenarioId] = useState(null);
  const [showHelp, setShowHelp] = useState(false);
  
  // Column visibility
  const [visibleColumns, setVisibleColumns] = useState([
    'parameters', 'status', 'results', 'improvement', 'created', 'actions'
  ]);
  
  const availableColumns = [
    { key: 'parameters', label: 'Parameters', required: false },
    { key: 'status', label: 'Status', required: false },
    { key: 'results', label: 'Results', required: false },
    { key: 'improvement', label: 'Improvement', required: false },
    { key: 'processing_time', label: 'Processing Time', required: false },
    { key: 'total_items', label: 'Total Items', required: false },
    { key: 'created', label: 'Created', required: false },
    { key: 'notes', label: 'Notes', required: false },
    { key: 'actions', label: 'Actions', required: true }
  ];
  
  // Fetch scenarios list
  const { data: scenarios = [], isLoading: scenariosLoading, refetch: refetchScenarios } = useQuery({
    queryKey: ['clustering-scenarios', entityType],
    queryFn: () => getClusteringScenarios(entityType),
    refetchInterval: 10000,
  });
  
  // Fetch selected scenario details
  const { data: selectedScenario } = useQuery({
    queryKey: ['clustering-scenario-details', selectedScenarioId],
    queryFn: () => getClusteringScenarioDetails(selectedScenarioId),
    enabled: !!selectedScenarioId,
    refetchInterval: (data) => {
      return data?.status === 'processing' ? 5000 : false;
    }
  });

  // Fetch expanded scenario details for visualization
  const { data: expandedScenario } = useQuery({
    queryKey: ['clustering-scenario-details', expandedScenarioId],
    queryFn: () => getClusteringScenarioDetails(expandedScenarioId),
    enabled: !!expandedScenarioId && expandedScenarioId !== selectedScenarioId,
    refetchInterval: (data) => {
      return data?.status === 'processing' ? 5000 : false;
    }
  });
  
  // Create scenario mutation
  const createMutation = useMutation({
    mutationFn: (data) => createClusteringScenario(data),
    onSuccess: () => {
      queryClient.invalidateQueries(['clustering-scenarios']);
      setShowCreatePanel(false);
    },
    onError: (error) => {
      alert('Failed to create scenario: ' + error.message);
    }
  });
  
  // Delete scenario mutation
  const deleteMutation = useMutation({
    mutationFn: (id) => deleteClusteringScenario(id),
    onSuccess: () => {
      queryClient.invalidateQueries(['clustering-scenarios']);
      if (selectedScenarioId === id) {
        setSelectedScenarioId(null);
      }
    },
    onError: (error) => {
      alert('Failed to delete scenario: ' + error.message);
    }
  });
  
  const handleCreateScenario = () => {
    createMutation.mutate({
      entityType,
      kValue,
      similarityThreshold,
      requestedBy: 'UI User',
      notes: `K=${kValue}, T=${similarityThreshold}`
    });
  };
  
  const handleSort = (field) => {
    if (sortField === field) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortOrder('asc');
    }
  };
  
  // Sort scenarios
  const sortedScenarios = [...scenarios].sort((a, b) => {
    let aVal = a[sortField];
    let bVal = b[sortField];
    
    if (aVal === null || aVal === undefined) return 1;
    if (bVal === null || bVal === undefined) return -1;
    
    if (typeof aVal === 'string') {
      aVal = aVal.toLowerCase();
      bVal = bVal.toLowerCase();
    }
    
    if (sortOrder === 'asc') {
      return aVal > bVal ? 1 : -1;
    } else {
      return aVal < bVal ? 1 : -1;
    }
  });
  
  // Helper function for status colors
  const getStatusColor = (status) => {
    switch (status) {
      case 'pending': return 'bg-yellow-100 text-yellow-800';
      case 'processing': return 'bg-blue-100 text-blue-800';
      case 'completed': return 'bg-green-100 text-green-800';
      case 'failed': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const getImprovementColor = (value) => {
    if (value > 5) return 'text-green-600 font-bold';
    if (value > 0) return 'text-green-600';
    if (value > -5) return 'text-gray-600';
    return 'text-red-600';
  };
  
  // Current production stats (mock for now)
  const currentStats = {
    k: entityType === 'problem' ? 15 : 10,
    threshold: entityType === 'problem' ? 0.55 : 0.60,
    outliers: entityType === 'problem' ? 28 : 30
  };
  
  const SortIcon = ({ field }) => {
    if (sortField !== field) {
      return <ChevronUp className="h-3 w-3 text-gray-400" />;
    }
    return sortOrder === 'asc' ? 
      <ChevronUp className="h-3 w-3 text-gray-700" /> : 
      <ChevronDown className="h-3 w-3 text-gray-700" />;
  };
  
  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-full mx-auto">
        {/* Header Section */}
        <div className="bg-white shadow-sm border-b">
          <div className="px-6 py-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-6">
                <h1 className="text-2xl font-semibold text-gray-900">Clustering Scenarios</h1>
                
                {/* Current Production Info */}
                <div className="flex items-center gap-4 text-sm text-gray-600 border-l pl-6">
                  <span className="font-medium">Production:</span>
                  <span>K={currentStats.k}</span>
                  <span>T={currentStats.threshold}</span>
                  <span className="text-red-600 font-medium">{currentStats.outliers}% outliers</span>
                </div>
              </div>
              
              <div className="flex items-center gap-2">
                {/* Quick Create Controls */}
                {showCreatePanel && (
                  <div className="flex items-center gap-3 mr-4 p-3 bg-gray-50 rounded-lg border">
                    {/* K Value */}
                    <div className="flex items-center gap-2">
                      <label className="text-xs font-medium text-gray-600 flex items-center gap-1">
                        K:
                        <span className="group relative">
                          <HelpCircle className="h-3 w-3 text-gray-400 cursor-help" />
                          <div className="invisible group-hover:visible absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 p-2 bg-gray-800 text-white text-xs rounded-lg w-48 z-10">
                            <div className="font-semibold mb-1">Number of Clusters (K)</div>
                            <div>How many groups to organize items into.</div>
                            <div className="mt-1">â€¢ Lower K = Fewer, larger clusters</div>
                            <div>â€¢ Higher K = More, smaller clusters</div>
                            <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-full">
                              <div className="border-4 border-transparent border-t-gray-800"></div>
                            </div>
                          </div>
                        </span>
                      </label>
                      <input
                        type="range"
                        min="5"
                        max="40"
                        value={kValue}
                        onChange={(e) => setKValue(Number(e.target.value))}
                        className="w-24 h-1 bg-gray-300 rounded-lg appearance-none cursor-pointer"
                      />
                      <span className="text-sm font-bold text-blue-600 w-8">{kValue}</span>
                    </div>
                    
                    {/* Threshold */}
                    <div className="flex items-center gap-2">
                      <label className="text-xs font-medium text-gray-600 flex items-center gap-1">
                        T:
                        <span className="group relative">
                          <HelpCircle className="h-3 w-3 text-gray-400 cursor-help" />
                          <div className="invisible group-hover:visible absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 p-2 bg-gray-800 text-white text-xs rounded-lg w-48 z-10">
                            <div className="font-semibold mb-1">Similarity Threshold (T)</div>
                            <div>Minimum similarity to join a cluster.</div>
                            <div className="mt-1">â€¢ Lower T = More items per cluster</div>
                            <div>â€¢ Higher T = Stricter grouping</div>
                            <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-full">
                              <div className="border-4 border-transparent border-t-gray-800"></div>
                            </div>
                          </div>
                        </span>
                      </label>
                      <input
                        type="range"
                        min="0.3"
                        max="0.8"
                        step="0.05"
                        value={similarityThreshold}
                        onChange={(e) => setSimilarityThreshold(Number(e.target.value))}
                        className="w-24 h-1 bg-gray-300 rounded-lg appearance-none cursor-pointer"
                      />
                      <span className="text-sm font-bold text-blue-600 w-10">{similarityThreshold}</span>
                    </div>
                    
                    {/* Create Button */}
                    <button
                      onClick={handleCreateScenario}
                      disabled={createMutation.isLoading}
                      className="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 disabled:opacity-50"
                    >
                      {createMutation.isLoading ? 'Creating...' : 'Create'}
                    </button>
                    
                    <button
                      onClick={() => setShowCreatePanel(false)}
                      className="text-gray-400 hover:text-gray-600 p-1"
                    >
                      âœ•
                    </button>
                  </div>
                )}
                
                {!showCreatePanel && (
                  <button
                    onClick={() => setShowCreatePanel(true)}
                    className="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 flex items-center gap-2"
                  >
                    <Plus className="h-4 w-4" />
                    New Scenario
                  </button>
                )}
                
                <ColumnSelector
                  columns={availableColumns}
                  selectedColumns={visibleColumns}
                  onColumnChange={setVisibleColumns}
                />
                
                <button
                  onClick={() => setShowHelp(!showHelp)}
                  className={`p-2 rounded-lg transition-colors ${
                    showHelp ? 'bg-blue-100 text-blue-600' : 'text-gray-600 hover:bg-gray-100'
                  }`}
                  title="Help & Guidance"
                >
                  <HelpCircle className="h-5 w-5" />
                </button>
                
                <button
                  onClick={() => refetchScenarios()}
                  className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                  title="Refresh"
                >
                  <RefreshCw className="h-5 w-5" />
                </button>
              </div>
            </div>
          </div>
        </div>
        
        {/* Help Section */}
        {showHelp && (
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mx-6 mb-4">
            <div className="flex justify-between items-start">
              <div className="flex-1">
                <h3 className="font-semibold text-blue-900 mb-2 flex items-center gap-2">
                  <Info className="h-4 w-4" />
                  Clustering Configuration Guide
                </h3>
                <div className="grid grid-cols-2 gap-4 text-sm text-blue-800">
                  <div>
                    <div className="font-medium mb-1">ðŸŽ¯ To Reduce Outliers:</div>
                    <ul className="space-y-1 text-xs">
                      <li>â€¢ <strong>Decrease K</strong> - Create fewer, larger clusters</li>
                      <li>â€¢ <strong>Lower T</strong> - Allow items with less similarity to join clusters</li>
                      <li>â€¢ Start with K=15-20 and T=0.50-0.55</li>
                    </ul>
                  </div>
                  <div>
                    <div className="font-medium mb-1">ðŸ“Š To Improve Quality:</div>
                    <ul className="space-y-1 text-xs">
                      <li>â€¢ <strong>Increase K</strong> - Create more focused groups</li>
                      <li>â€¢ <strong>Raise T</strong> - Ensure tighter similarity within clusters</li>
                      <li>â€¢ Monitor outlier % (aim for &lt;20%)</li>
                    </ul>
                  </div>
                </div>
                <div className="mt-3 p-2 bg-white rounded border border-blue-200">
                  <div className="text-xs text-gray-600">
                    <strong>Pro tip:</strong> Create multiple scenarios with different settings and compare results. 
                    The best configuration balances low outliers with meaningful cluster groupings. 
                    Use the eye icon to examine cluster contents before applying to production.
                  </div>
                </div>
              </div>
              <button
                onClick={() => setShowHelp(false)}
                className="text-blue-400 hover:text-blue-600 p-1"
              >
                âœ•
              </button>
            </div>
          </div>
        )}
        
        {/* Table Section */}
        <div className="bg-white shadow-sm">
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="w-12 px-4"></th>
                  {visibleColumns.includes('parameters') && (
                    <th 
                      className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onClick={() => handleSort('k_value')}
                    >
                      <div className="flex items-center gap-1">
                        Parameters
                        <SortIcon field="k_value" />
                      </div>
                    </th>
                  )}
                  {visibleColumns.includes('status') && (
                    <th 
                      className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onClick={() => handleSort('status')}
                    >
                      <div className="flex items-center gap-1">
                        Status
                        <SortIcon field="status" />
                      </div>
                    </th>
                  )}
                  {visibleColumns.includes('results') && (
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Results
                    </th>
                  )}
                  {visibleColumns.includes('improvement') && (
                    <th 
                      className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onClick={() => handleSort('outlier_improvement_percentage')}
                    >
                      <div className="flex items-center gap-1">
                        Improvement
                        <SortIcon field="outlier_improvement_percentage" />
                      </div>
                    </th>
                  )}
                  {visibleColumns.includes('processing_time') && (
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Processing Time
                    </th>
                  )}
                  {visibleColumns.includes('total_items') && (
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Total Items
                    </th>
                  )}
                  {visibleColumns.includes('notes') && (
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Notes
                    </th>
                  )}
                  {visibleColumns.includes('created') && (
                    <th 
                      className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                      onClick={() => handleSort('requested_at')}
                    >
                      <div className="flex items-center gap-1">
                        Created
                        <SortIcon field="requested_at" />
                      </div>
                    </th>
                  )}
                  {visibleColumns.includes('actions') && (
                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Actions
                    </th>
                  )}
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {scenariosLoading ? (
                  <tr>
                    <td colSpan={visibleColumns.length} className="px-6 py-12 text-center text-gray-500">
                      <div className="flex flex-col items-center">
                        <RefreshCw className="h-8 w-8 text-gray-400 animate-spin mb-2" />
                        Loading scenarios...
                      </div>
                    </td>
                  </tr>
                ) : sortedScenarios.length === 0 ? (
                  <tr>
                    <td colSpan={visibleColumns.length} className="px-6 py-12 text-center text-gray-500">
                      <div className="flex flex-col items-center">
                        <div className="text-lg mb-2">No scenarios yet</div>
                        <div className="text-sm">Click "New Scenario" to create one</div>
                      </div>
                    </td>
                  </tr>
                ) : (
                  sortedScenarios.map((scenario) => (
                    <React.Fragment key={scenario.id}>
                    <tr 
                      className={`hover:bg-gray-50 cursor-pointer ${
                        selectedScenarioId === scenario.id ? 'bg-blue-50' : ''
                      }`}
                      onClick={() => setExpandedScenarioId(expandedScenarioId === scenario.id ? null : scenario.id)}
                    >
                      <td className="px-4 py-3 text-center">
                        <span className="text-gray-400 text-sm">
                          {expandedScenarioId === scenario.id ? 'â–¼' : 'â–¶'}
                        </span>
                      </td>
                      {visibleColumns.includes('parameters') && (
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm">
                            <span className="font-medium text-gray-900">K={scenario.k_value}</span>
                            <span className="text-gray-500 ml-2">T={scenario.similarity_threshold}</span>
                          </div>
                        </td>
                      )}
                      {visibleColumns.includes('status') && (
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(scenario.status)}`}>
                            {scenario.status}
                            {scenario.status === 'processing' && (
                              <div className="ml-2 animate-spin h-3 w-3 border-2 border-current border-t-transparent rounded-full"></div>
                            )}
                          </span>
                        </td>
                      )}
                      {visibleColumns.includes('results') && (
                        <td className="px-6 py-4 whitespace-nowrap">
                          {scenario.status === 'completed' ? (
                            <div className="text-sm">
                              <span className="font-medium text-gray-900">{scenario.cluster_count} clusters</span>
                              <span className="text-red-600 ml-2">{scenario.outlier_percentage}% outliers</span>
                            </div>
                          ) : (
                            <span className="text-sm text-gray-400">-</span>
                          )}
                        </td>
                      )}
                      {visibleColumns.includes('improvement') && (
                        <td className="px-6 py-4 whitespace-nowrap">
                          {scenario.status === 'completed' ? (
                            <span className={`text-sm font-medium ${getImprovementColor(scenario.outlier_improvement_percentage)}`}>
                              {scenario.outlier_improvement_percentage > 0 ? '+' : ''}{scenario.outlier_improvement_percentage}%
                            </span>
                          ) : (
                            <span className="text-sm text-gray-400">-</span>
                          )}
                        </td>
                      )}
                      {visibleColumns.includes('processing_time') && (
                        <td className="px-6 py-4 whitespace-nowrap">
                          {scenario.processing_time_seconds ? (
                            <span className="text-sm text-gray-600">
                              {Math.round(scenario.processing_time_seconds)}s
                            </span>
                          ) : (
                            <span className="text-sm text-gray-400">-</span>
                          )}
                        </td>
                      )}
                      {visibleColumns.includes('total_items') && (
                        <td className="px-6 py-4 whitespace-nowrap">
                          {scenario.total_items ? (
                            <span className="text-sm text-gray-900">{scenario.total_items}</span>
                          ) : (
                            <span className="text-sm text-gray-400">-</span>
                          )}
                        </td>
                      )}
                      {visibleColumns.includes('notes') && (
                        <td className="px-6 py-4">
                          {scenario.notes ? (
                            <span className="text-sm text-gray-600 truncate max-w-xs block">{scenario.notes}</span>
                          ) : (
                            <span className="text-sm text-gray-400">-</span>
                          )}
                        </td>
                      )}
                      {visibleColumns.includes('created') && (
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className="text-sm text-gray-600">
                            {formatDateTime(scenario.requested_at)}
                          </span>
                        </td>
                      )}
                      {visibleColumns.includes('actions') && (
                        <td className="px-6 py-4 whitespace-nowrap text-center">
                          <div className="flex items-center justify-center gap-1">
                            {scenario.status === 'completed' && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setSelectedScenarioId(scenario.id);
                                  setShowResults(true);
                                }}
                                className="p-2 rounded-lg transition-all transform hover:scale-110 text-purple-500 hover:text-purple-700 hover:bg-purple-100"
                                title="View Details"
                              >
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                  <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                              </button>
                            )}
                            {scenario.status !== 'processing' && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  if (confirm('Delete this scenario?')) {
                                    deleteMutation.mutate(scenario.id);
                                  }
                                }}
                                className="p-2 rounded-lg transition-all transform hover:scale-110 text-red-500 hover:text-red-700 hover:bg-red-100"
                                title="Delete"
                              >
                                <Trash2 className="h-4 w-4" />
                              </button>
                            )}
                          </div>
                        </td>
                      )}
                    </tr>
                    {expandedScenarioId === scenario.id && (
                      <tr>
                        <td colSpan={visibleColumns.length + 1} className="px-0 py-0 bg-gray-50">
                          <div className="border-l-4 border-blue-400 ml-8">
                            {scenario.status === 'completed' && (expandedScenario || selectedScenario) ? (
                              <ClusterVisualization scenario={expandedScenario || selectedScenario} />
                            ) : scenario.status === 'processing' ? (
                              <div className="p-8 text-center text-gray-500">
                                <RefreshCw className="h-8 w-8 animate-spin mx-auto mb-2" />
                                Processing scenario...
                              </div>
                            ) : scenario.status === 'completed' ? (
                              <div className="p-8 text-center text-gray-500">
                                <RefreshCw className="h-8 w-8 animate-spin mx-auto mb-2" />
                                Loading visualization...
                              </div>
                            ) : (
                              <div className="p-8 text-center text-gray-500">
                                Scenario not yet processed
                              </div>
                            )}
                          </div>
                        </td>
                      </tr>
                    )}
                    </React.Fragment>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      {/* Enhanced Scenario Results Modal */}
      {showResults && selectedScenarioId && (
        <ScenarioResults 
          scenarioId={selectedScenarioId}
          onClose={() => {
            setShowResults(false);
            refetchScenarios();
          }}
        />
      )}
    </div>
  );
}

export default ClusterConfiguration;